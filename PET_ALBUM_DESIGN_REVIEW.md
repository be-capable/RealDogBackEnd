# å® ç‰©ç›¸å†ŒåŠŸèƒ½æ·±åº¦è®¾è®¡ä¸å…¼å®¹æ€§åˆ†ææŠ¥å‘Š

## ğŸ“Š æ‰§è¡Œæ‘˜è¦

**è¯„ä¼°æ—¥æœŸ**: 2026-02-01
**åŠŸèƒ½çŠ¶æ€**: ğŸŸ¡ éœ€è¦ä¿®å¤å…³é”®é—®é¢˜
**å…¼å®¹æ€§**: âš ï¸ éƒ¨åˆ†å½±å“ç°æœ‰ä¸šåŠ¡

---

## ä¸€ã€è®¾è®¡è¯„ä¼°ï¼šæ˜¯å¦ä¼šæ‹›äººå–œæ¬¢ï¼Ÿ

### 1.1 ç”¨æˆ·ä½“éªŒåˆ†æ

| ç»´åº¦ | å½“å‰è®¾è®¡ | è¡Œä¸šæ ‡å‡† | å·®è· |
|------|----------|----------|------|
| **åŠ è½½ä½“éªŒ** | âœ… æ‡’åŠ è½½ + Loading | âœ… ä¼˜ç§€ | æ— å·®è· |
| **ä¸Šä¼ æµç¨‹** | âš ï¸ æ— è¿›åº¦åé¦ˆ | âœ… å®æ—¶è¿›åº¦æ¡ | ä¸­ |
| **åˆ é™¤ç¡®è®¤** | âœ… äºŒæ¬¡ç¡®è®¤ | âœ… ä¼˜ç§€ | æ— å·®è· |
| **ç©ºçŠ¶æ€** | âœ… å¼•å¯¼æç¤º | âœ… ä¼˜ç§€ | æ— å·®è· |
| **å›¾ç‰‡å±•ç¤º** | âœ… ç½‘æ ¼å¸ƒå±€ | âœ… ä¼˜ç§€ | æ— å·®è· |
| **å¤§å›¾æŸ¥çœ‹** | âœ… PhotoView | âœ… ç¼©æ”¾æ”¯æŒ | æ— å·®è· |

### 1.2 ç¼ºå¤±çš„å…³é”®åŠŸèƒ½

```
âŒ ç¼ºå¤±åŠŸèƒ½ä¼˜å…ˆçº§:
â”œâ”€â”€ P0 (å¿…é¡»ä¿®å¤)
â”‚   â”œâ”€â”€ ç…§ç‰‡è¯„è®º/ç‚¹èµåŠŸèƒ½
â”‚   â”œâ”€â”€ ç›¸å†Œå°é¢è®¾ç½®
â”‚   â””â”€â”€ æŒ‰æ—¶é—´ç­›é€‰
â”œâ”€â”€ P1 (å¼ºçƒˆå»ºè®®)
â”‚   â”œâ”€â”€ ç›¸å†Œåˆ†äº«åˆ°ç¤¾äº¤åª’ä½“
â”‚   â”œâ”€â”€ æ‰¹é‡ä¸Šä¼ 
â”‚   â””â”€â”€ ç…§ç‰‡æè¿°/æ ‡ç­¾
â””â”€â”€ P2 (é”¦ä¸Šæ·»èŠ±)
    â”œâ”€â”€ AI è‡ªåŠ¨åˆ†ç±»
    â”œâ”€â”€ ç…§ç‰‡æ•…äº‹ç”Ÿæˆ
    â””â”€â”€ è®°å¿†å›é¡¾åŠ¨ç”»
```

### 1.3 è®¾è®¡è¯„åˆ†

| ç±»åˆ« | è¯„åˆ† (5åˆ†åˆ¶) | è¯´æ˜ |
|------|-------------|------|
| UI è§†è§‰ | 4/5 | ç¬¦åˆæ•´ä½“é£æ ¼ï¼Œæœ‰åŠ¨ç”»æ•ˆæœ |
| äº¤äº’ä½“éªŒ | 3/5 | ç¼ºå°‘ä¸Šä¼ è¿›åº¦ |
| åŠŸèƒ½å®Œæ•´ | 2/5 | ç¼ºå°‘æ ¸å¿ƒç¤¾äº¤åŠŸèƒ½ |
| æ€§èƒ½ä¼˜åŒ– | 4/5 | æ‡’åŠ è½½ã€åˆ†é¡µéƒ½æœ‰ |
| **ç»¼åˆ** | **3.25/5** | **åŸºç¡€åŠŸèƒ½å®Œæ•´ï¼Œç¤¾äº¤å±æ€§ä¸è¶³** |

---

## äºŒã€åå°æ¥å£æ·±åº¦åˆ†æ

### 2.1 API è®¾è®¡è¯„ä¼°

```
API ENDPOINTS:
â”œâ”€â”€ GET    /api/pets/:petId/media          âœ… RESTful
â”œâ”€â”€ POST   /api/pets/:petId/media          âœ… RESTful  
â”œâ”€â”€ DELETE /api/media/:mediaId             âœ… RESTful
â””â”€â”€ POST   /api/pets/:petId/avatar         âœ… ç‹¬ç«‹å¤´åƒæ¥å£
```

### 2.2 å…³é”®é—®é¢˜å‘ç° âš ï¸

#### é—®é¢˜ 1: å¤´åƒåˆ é™¤æ•°æ®ä¸ä¸€è‡´ (ä¸¥é‡)
```typescript
// å½“å‰ä»£ç : pet-media.service.ts:99-118
// åˆ é™¤å¤´åƒæ—¶ï¼Œåªåˆ é™¤äº† PetMedia è®°å½•
// ä½† Pet.avatarMediaId ä»æŒ‡å‘å·²åˆ é™¤çš„åª’ä½“ID

async deleteMedia(userId: number, mediaId: number) {
  const media = await this.prisma.petMedia.findFirst({...});
  
  await this.prisma.petMedia.delete({ where: { id: media.id } });
  
  // âŒ ç¼ºå¤±: å¦‚æœåˆ é™¤çš„æ˜¯å¤´åƒï¼Œéœ€è¦æ¸…ç©º pet.avatarMediaId
}
```

**å½±å“**: 
- å® ç‰©åˆ—è¡¨é¡µè·å– avatarMedia æ—¶å¯èƒ½è¿”å› null æˆ– 404
- æ•°æ®ä¸€è‡´æ€§ç ´å

#### é—®é¢˜ 2: åˆ—è¡¨åŒ…å«æ‰€æœ‰ç±»å‹ (ä¸­)
```typescript
// å½“å‰: listByPet è¿”å›æ‰€æœ‰ç±»å‹çš„ media
// åŒ…æ‹¬: PHOTO, VIDEO, AVATAR

// å½±å“: å® ç‰©ç›¸å†Œä¸­ä¼šæ˜¾ç¤ºå¤´åƒå›¾ç‰‡
```

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
async listByPet(userId: number, petId: number, page = 1, limit = 20) {
  await this.assertPetOwnership(userId, petId);
  
  const [data, total] = await Promise.all([
    this.prisma.petMedia.findMany({
      where: { 
        petId,
        type: { in: ['PHOTO', 'VIDEO'] }, // âœ… åªè¿”å›ç›¸å†Œå†…å®¹
      },
      orderBy: [{ createdAt: 'desc' }],
      skip: (page - 1) * limit,
      take: limit,
    }),
    this.prisma.petMedia.count({ 
      where: { petId, type: { in: ['PHOTO', 'VIDEO'] } } 
    }),
  ]);
  
  return { data, total, page, limit, hasMore: page * limit < total };
}
```

#### é—®é¢˜ 3: ç¼ºå°‘æ–‡ä»¶å¤§å°é™åˆ¶ (ä¸­)
```typescript
// å½“å‰: æ— é™åˆ¶
// å»ºè®®: æ·»åŠ  10MB é™åˆ¶
```

#### é—®é¢˜ 4: ç¼ºå°‘å›¾ç‰‡å°ºå¯¸ä¿¡æ¯ (ä½)
```typescript
// å½“å‰: width, height å­—æ®µå­˜åœ¨ä½†æœªå¡«å……
// å»ºè®®: ä½¿ç”¨ sharp/image-size è·å–å°ºå¯¸
```

---

## ä¸‰ã€ç§»åŠ¨ç«¯ä¸šåŠ¡é€»è¾‘å…¼å®¹æ€§åˆ†æ

### 3.1 ä¸ç°æœ‰åŠŸèƒ½çš„å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·æ“ä½œæµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  åˆ›å»ºå® ç‰© â”€â”€â”¬â”€â”€> ä¸Šä¼ å¤´åƒ â”€â”€> PetMedia (AVATAR)              â”‚
â”‚             â”‚              â”‚                                 â”‚
â”‚             â”‚              â””â”€â”€> Pet.avatarMediaId = media.id â”‚
â”‚             â”‚                                                   â”‚
â”‚             â””â”€â”€> ç›¸å†Œç®¡ç† â”€â”€> ä¸Šä¼ ç…§ç‰‡ â”€â”€> PetMedia (PHOTO)   â”‚
â”‚                                 â”‚                            â”‚
â”‚                                 â””â”€â”€> ç›¸å†Œå±•ç¤º                â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 å…¼å®¹æ€§é—®é¢˜

| é—®é¢˜ | å½±å“èŒƒå›´ | ä¸¥é‡ç¨‹åº¦ |
|------|----------|----------|
| åˆ é™¤å¤´åƒåå® ç‰©åˆ—è¡¨ä¸åˆ·æ–° | å® ç‰©åˆ—è¡¨é¡µ | ğŸ”´ é«˜ |
| ç›¸å†Œæ˜¾ç¤ºå¤´åƒå›¾ç‰‡ | ç›¸å†Œé¡µé¢ | ğŸŸ¡ ä¸­ |
| å® ç‰©åˆ é™¤æœªçº§è”åˆ é™¤åª’ä½“ | æ•°æ®å®Œæ•´æ€§ | ğŸŸ¡ ä¸­ |
| ä¸Šä¼ å¤±è´¥æ— æ˜ç¡®é”™è¯¯æç¤º | ç”¨æˆ·ä½“éªŒ | ğŸŸ¡ ä¸­ |

### 3.3 å…³é”®ä»£ç é—®é¢˜

#### é—®é¢˜ 1: åˆ é™¤å¤´åƒåçŠ¶æ€æœªåŒæ­¥
```dart
// pet_media_controller.dart:103-113
Future<void> deleteMedia(int mediaId) async {
  final current = state.value ?? [];
  state = AsyncValue.data(current.where((m) => m.id != mediaId).toList());

  try {
    await ref.read(petMediaRepositoryProvider).deleteMedia(mediaId);
    // âŒ ç¼ºå¤±: é€šçŸ¥ petsController åˆ·æ–°
  } catch (e) {
    ...
  }
}
```

#### é—®é¢˜ 2: å® ç‰©æ•°æ®æœªå®æ—¶æ›´æ–°
```dart
// pet_album_screen.dart
// ä¸Šä¼ ç…§ç‰‡åï¼ŒpetsController çš„å® ç‰©åˆ—è¡¨ä¸ä¼šè‡ªåŠ¨æ›´æ–°
// å¯¼è‡´å® ç‰©å¤´åƒä¸ä¼šå› ä¸ºä¸Šä¼ æ–°ç…§ç‰‡è€Œæ”¹å˜
```

---

## å››ã€å¯¹ç°æœ‰ä¸šåŠ¡çš„å½±å“è¯„ä¼°

### 4.1 å—å½±å“çš„åŠŸèƒ½æ¨¡å—

| æ¨¡å— | å½±å“ | è¯´æ˜ |
|------|------|------|
| å® ç‰©åˆ—è¡¨ | âš ï¸ ä½ | å¤´åƒæ˜¾ç¤ºå¯èƒ½å¼‚å¸¸ |
| åˆ›å»ºå® ç‰© | âœ… æ— å½±å“ | ç‹¬ç«‹æµç¨‹ |
| ç‹—å«ç¿»è¯‘ | âœ… æ— å½±å“ | ç‹¬ç«‹æ¨¡å— |
| äº‹ä»¶è®°å½• | âœ… æ— å½±å“ | ç‹¬ç«‹æ¨¡å— |
| ç”¨æˆ·è®¤è¯ | âœ… æ— å½±å“ | ç‹¬ç«‹æ¨¡å— |

### 4.2 æ•°æ®ä¸€è‡´æ€§é£é™©

```
é£é™©çŸ©é˜µ:
                    å½±å“èŒƒå›´
                 å°          å¤§
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    é«˜é£é™©  â”‚         â”‚  ğŸ”´ P0  â”‚
 å¯èƒ½æ€§     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    ä½é£é™©  â”‚  ğŸŸ¡ P1  â”‚  ğŸŸ¢ P2  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

P0: å¤´åƒåˆ é™¤æ•°æ®ä¸ä¸€è‡´ (é«˜é£é™©, å¤§èŒƒå›´)
P1: ç›¸å†Œæ˜¾ç¤ºå¤´åƒ (ä½é£é™©, å°èŒƒå›´)  
P2: ç¼ºå°‘æ–‡ä»¶é™åˆ¶ (ä½é£é™©, å°èŒƒå›´)
```

---

## äº”ã€ä¿®å¤å»ºè®®ä¸ä¼˜å…ˆçº§

### 5.1 ç«‹å³ä¿®å¤ (P0) - é˜²æ­¢æ•°æ®æŸå

```typescript
// 1. åç«¯: ä¿®å¤å¤´åƒåˆ é™¤é€»è¾‘
async deleteMedia(userId: number, mediaId: number) {
  const media = await this.prisma.petMedia.findFirst({
    where: { id: mediaId, pet: { ownerId: userId } },
  });
  
  if (!media) throw new NotFoundException('Media not found');

  // ğŸ”§ ä¿®å¤: å¦‚æœæ˜¯å¤´åƒï¼Œè§£é™¤å…³è”
  if (media.type === 'AVATAR') {
    await this.prisma.pet.updateMany({
      where: { avatarMediaId: media.id },
      data: { avatarMediaId: null },
    });
  }

  await this.prisma.petMedia.delete({ where: { id: media.id } });
  // ... æ–‡ä»¶æ¸…ç†é€»è¾‘
}
```

```dart
// 2. ç§»åŠ¨ç«¯: åˆ é™¤ååˆ·æ–°å® ç‰©åˆ—è¡¨
Future<void> deleteMedia(int mediaId) async {
  final current = state.value ?? [];
  state = AsyncValue.data(current.where((m) => m.id != mediaId).toList());

  try {
    await ref.read(petMediaRepositoryProvider).deleteMedia(mediaId);
    
    // ğŸ”§ ä¿®å¤: åˆ·æ–°å® ç‰©åˆ—è¡¨ï¼ˆå¤´åƒå¯èƒ½æ”¹å˜ï¼‰
    await ref.read(petsControllerProvider.notifier).refresh();
  } catch (e) {
    state = AsyncValue.error(e, StackTrace.current);
    await loadMedia(_currentPetId ?? 0);
  }
}
```

### 5.2 çŸ­æœŸä¿®å¤ (P1) - æå‡ä½“éªŒ

```typescript
// 3. åç«¯: åˆ—è¡¨è¿‡æ»¤å¤´åƒç±»å‹
async listByPet(userId: number, petId: number, page = 1, limit = 20) {
  await this.assertPetOwnership(userId, petId);

  const [data, total] = await Promise.all([
    this.prisma.petMedia.findMany({
      where: { 
        petId,
        type: { in: ['PHOTO', 'VIDEO'] },  // ğŸ”§ è¿‡æ»¤å¤´åƒ
      },
      orderBy: [{ createdAt: 'desc' }],
      skip: (page - 1) * limit,
      take: limit,
    }),
    this.prisma.petMedia.count({ 
      where: { petId, type: { in: ['PHOTO', 'VIDEO'] } } 
    }),
  ]);

  return { data, total, page, limit, hasMore: page * limit < total };
}
```

```dart
// 4. ç§»åŠ¨ç«¯: æ·»åŠ ä¸Šä¼ è¿›åº¦
Future<void> uploadPhoto(int petId, File file) async {
  // ğŸ”§ æ”¹è¿›: æ˜¾ç¤ºä¸Šä¼ ä¸­çŠ¶æ€
  state = AsyncValue.loading();
  
  try {
    final media = await repo.uploadMedia(petId, file: file, type: PetMediaType.photo);
    final current = state.value ?? [];
    state = AsyncValue.data([media, ...current]);
    
    // ğŸ”§ åˆ·æ–°å® ç‰©åˆ—è¡¨
    ref.read(petsControllerProvider.notifier).refresh();
  } catch (e) {
    state = AsyncValue.error(e, StackTrace.current);
  }
}
```

### 5.3 ä¸­æœŸä¼˜åŒ– (P2)

| åŠŸèƒ½ | å·¥ä½œé‡ | ä»·å€¼ |
|------|--------|------|
| æ·»åŠ æ–‡ä»¶å¤§å°é™åˆ¶ (10MB) | 2å°æ—¶ | é«˜ |
| å›¾ç‰‡å‹ç¼©å­˜å‚¨ | 4å°æ—¶ | é«˜ |
| ä¸Šä¼ è¿›åº¦æ¡ UI | 3å°æ—¶ | é«˜ |
| AI ç…§ç‰‡åˆ†ç±» | 2å¤© | ä¸­ |
| ç¤¾äº¤åˆ†äº«åŠŸèƒ½ | 3å¤© | ä¸­ |

---

## å…­ã€ç»“è®ºä¸è¡ŒåŠ¨å»ºè®®

### 6.1 æ€»ä½“è¯„ä¼°

| ç»´åº¦ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| **åŠŸèƒ½å®Œæ•´æ€§** | ğŸŸ¡ 70% | åŸºç¡€åŠŸèƒ½OKï¼Œç¤¾äº¤åŠŸèƒ½ç¼ºå¤± |
| **ä»£ç è´¨é‡** | ğŸŸ¡ 75% | æœ‰éšæ‚£éœ€ä¿®å¤ |
| **ä¸šåŠ¡å…¼å®¹æ€§** | ğŸŸ¡ 80% | æœ‰å°é—®é¢˜éœ€å¤„ç† |
| **ç”¨æˆ·ä½“éªŒ** | ğŸŸ¡ 65% | ç¼ºå°‘å…³é”®äº¤äº’åé¦ˆ |

### 6.2 æ˜¯å¦ä¼šæ‹›äººå–œæ¬¢ï¼Ÿ

**ç»“è®º**: **åŸºæœ¬åŠŸèƒ½å¯ä»¥ï¼Œä½†ç¼ºä¹"ç—…æ¯’å¼ä¼ æ’­"ç‰¹è´¨**

å® ç‰©ç›¸å†Œæ˜¯ä¸€ä¸ª**å·¥å…·å‹åŠŸèƒ½**ï¼Œç”¨æˆ·ä¼šä½¿ç”¨ä½†ä¸ä¼šä¸»åŠ¨åˆ†äº«ã€‚éœ€è¦æ·»åŠ ï¼š
- ç¤¾äº¤äº’åŠ¨ï¼ˆç‚¹èµã€è¯„è®ºï¼‰
- è®°å¿†å›é¡¾ï¼ˆå¹´åº¦ç…§ç‰‡ã€è§†é¢‘æ•…äº‹ï¼‰
- åˆ†äº«åŠ¨æœºï¼ˆç”Ÿæˆå¯åˆ†äº«çš„å›¾ç‰‡/è§†é¢‘ï¼‰

### 6.3 ç«‹å³è¡ŒåŠ¨é¡¹

```
ğŸ”´ ç«‹å³ä¿®å¤ (24å°æ—¶å†…):
â”œâ”€â”€ 1. åç«¯: ä¿®å¤å¤´åƒåˆ é™¤æ•°æ®ä¸€è‡´æ€§é—®é¢˜
â”œâ”€â”€ 2. ç§»åŠ¨ç«¯: åˆ é™¤åª’ä½“ååˆ·æ–°å® ç‰©åˆ—è¡¨
â””â”€â”€ 3. åç«¯: åˆ—è¡¨æ¥å£è¿‡æ»¤ AVATAR ç±»å‹

ğŸŸ¡ æœ¬å‘¨å®Œæˆ:
â”œâ”€â”€ 4. æ·»åŠ æ–‡ä»¶å¤§å°é™åˆ¶ (10MB)
â”œâ”€â”€ 5. ç§»åŠ¨ç«¯: æ·»åŠ ä¸Šä¼ è¿›åº¦UI
â””â”€â”€ 6. å® ç‰©åˆ é™¤æ—¶çº§è”åˆ é™¤åª’ä½“

ğŸŸ¢ åç»­è¿­ä»£:
â”œâ”€â”€ 7. æ·»åŠ ç…§ç‰‡è¯„è®º/ç‚¹èµåŠŸèƒ½
â”œâ”€â”€ 8. AI è‡ªåŠ¨åˆ†ç±»å’Œæ ‡ç­¾
â””â”€â”€ 9. ç¤¾äº¤åˆ†äº«åŠŸèƒ½
```

---

## é™„å½•ï¼šæµ‹è¯•ç”¨ä¾‹è¡¥å……

```typescript
// åº”è¯¥è¡¥å……çš„æµ‹è¯•ç”¨ä¾‹
describe('PetMedia Security', () => {
  it('should not return AVATAR type in gallery list', async () => {
    const avatar = await createAvatarMedia(petId);
    const photo = await createPhotoMedia(petId);
    
    const result = await service.listByPet(userId, petId);
    
    expect(result.data).not.toContainEqual(
      expect.objectContaining({ type: 'AVATAR' })
    );
    expect(result.data).toContainEqual(
      expect.objectContaining({ type: 'PHOTO' })
    );
  });

  it('should clear avatarMediaId when avatar is deleted', async () => {
    const avatar = await createAvatarMedia(petId);
    await service.updatePetAvatar(petId, avatar.id);
    
    await service.deleteMedia(userId, avatar.id);
    
    const pet = await prisma.pet.findUnique({ where: { id: petId } });
    expect(pet.avatarMediaId).toBeNull();
  });
});
```

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-02-01
**æŠ¥å‘Šç‰ˆæœ¬**: v1.0
**ä¸‹ä¸€æ­¥**: å®æ–½ä¿®å¤æ–¹æ¡ˆå¹¶å›å½’æµ‹è¯•

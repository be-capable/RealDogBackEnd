generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Comment {
  id            Int        @id @default(autoincrement())
  postId        Int
  userId        Int
  parentId      Int?
  content       String
  likesCount    Int        @default(0)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime
  Comment       Comment?   @relation("CommentToComment", fields: [parentId], references: [id])
  other_Comment Comment[]  @relation("CommentToComment")
  User          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  SocialPost    SocialPost @relation(fields: [postId], references: [id], onDelete: Cascade)
}

model DogEvent {
  id              Int      @id @default(autoincrement())
  petId           Int
  eventType       String
  stateType       String?
  contextType     String?
  confidence      Float?
  audioUrl        String?
  createdAt       DateTime @default(now())
  inputTranscript String?
  meaningText     String?
  mode            String?
  outputAudioUrl  String?
  Pet             Pet      @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@index([petId])
  @@index([createdAt])
  @@index([eventType])
}

model DogTask {
  id        String   @id
  userId    Int
  petId     Int
  type      String
  status    String
  result    String?
  error     String?
  createdAt DateTime @default(now())
  updatedAt DateTime
  User      User     @relation(fields: [userId], references: [id])
  Pet       Pet      @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([petId])
  @@index([status])
}

model Follow {
  id                            Int      @id @default(autoincrement())
  followerId                    Int
  followingId                   Int
  createdAt                     DateTime @default(now())
  User_Follow_followingIdToUser User     @relation("Follow_followingIdToUser", fields: [followingId], references: [id], onDelete: Cascade)
  User_Follow_followerIdToUser  User     @relation("Follow_followerIdToUser", fields: [followerId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Like {
  id         Int      @id @default(autoincrement())
  userId     Int
  targetId   Int
  targetType String
  createdAt  DateTime @default(now())
  User       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, targetId, targetType])
  @@index([userId])
  @@index([targetId, targetType])
}

model Notification {
  id                               Int      @id @default(autoincrement())
  userId                           Int
  senderId                         Int
  type                             String
  content                          String
  isRead                           Boolean  @default(false)
  createdAt                        DateTime @default(now())
  updatedAt                        DateTime
  User_Notification_senderIdToUser User     @relation("Notification_senderIdToUser", fields: [senderId], references: [id], onDelete: Cascade)
  User_Notification_userIdToUser   User     @relation("Notification_userIdToUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([senderId])
}

model Pet {
  id                                   Int          @id @default(autoincrement())
  ownerId                              Int
  species                              String       @default("DOG")
  name                                 String
  sex                                  String
  birthDate                            DateTime
  breedId                              String
  breedName                            String?      // 品种名称，便于显示
  isSpayedNeutered                     Boolean      @default(false)
  avatarMediaId                        Int?         @unique
  bio                                  String?      // 宠物简介
  createdAt                            DateTime     @default(now())
  updatedAt                            DateTime
  DogEvent                             DogEvent[]
  DogTask                              DogTask[]
  PetMedia_Pet_avatarMediaIdToPetMedia PetMedia?    @relation("Pet_avatarMediaIdToPetMedia", fields: [avatarMediaId], references: [id])
  User                                 User         @relation(fields: [ownerId], references: [id])
  PetMedia_PetMedia_petIdToPet         PetMedia[]   @relation("PetMedia_petIdToPet")
  SocialPost                           SocialPost[]

  @@index([ownerId])
  @@index([species])
}

model PetMedia {
  id                              Int      @id @default(autoincrement())
  petId                           Int
  type                            String
  objectKey                       String
  contentType                     String
  sizeBytes                       Int
  width                           Int?
  height                          Int?
  durationMs                      Int?
  createdAt                       DateTime @default(now())
  Pet_Pet_avatarMediaIdToPetMedia Pet?     @relation("Pet_avatarMediaIdToPetMedia")
  Pet_PetMedia_petIdToPet         Pet      @relation("PetMedia_petIdToPet", fields: [petId], references: [id], onDelete: Cascade)
}

model SocialPost {
  id            Int       @id @default(autoincrement())
  userId        Int
  petId         Int?
  content       String
  mediaUrls     String    @default("[]")
  location      String?
  tags          String    @default("[]")
  likesCount    Int       @default(0)
  commentsCount Int       @default(0)
  sharesCount   Int       @default(0)
  visibility    String    @default("PUBLIC")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime
  Comment       Comment[]
  Pet           Pet?      @relation(fields: [petId], references: [id])
  User          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([petId])
  @@index([createdAt])
  @@index([visibility])
}

model User {
  id                                       Int            @id @default(autoincrement())
  email                                    String         @unique
  password                                 String
  name                                     String?
  avatar                                   String?        // 用户头像
  bio                                      String?        // 个人简介
  createdAt                                DateTime       @default(now())
  updatedAt                                DateTime
  hashedRt                                 String?
  otp                                      String?
  otpExpiry                                DateTime?
  Comment                                  Comment[]
  DogTask                                  DogTask[]
  Follow_Follow_followingIdToUser          Follow[]       @relation("Follow_followingIdToUser")
  Follow_Follow_followerIdToUser           Follow[]       @relation("Follow_followerIdToUser")
  Like                                     Like[]
  Notification_Notification_senderIdToUser Notification[] @relation("Notification_senderIdToUser")
  Notification_Notification_userIdToUser   Notification[] @relation("Notification_userIdToUser")
  Pet                                      Pet[]
  SocialPost                               SocialPost[]

  @@index([email])
  @@index([createdAt])
}

model BlacklistedToken {
  token      String   @id
  expiresAt  DateTime

  @@index([expiresAt])
}
